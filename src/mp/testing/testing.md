# Overview

Helidon provides a JUnit5 extension that integrates CDI to support
testing with Helidon MP.

The test class is added as a CDI bean to support injection and the CDI
container is started lazily during test execution.

# Maven Coordinates

To enable Helidon MicroProfile Testing JUnit5, add the following
dependency to your project’s `pom.xml` (see [Managing Dependencies](../../about/managing-dependencies.md)).

```xml
<dependency>
    <groupId>io.helidon.microprofile.testing</groupId>
    <artifactId>helidon-microprofile-testing-junit5</artifactId>
    <scope>test</scope>
</dependency>
```

# Usage

Basic usage:
```java
@HelidonTest // Enable the test class
class MyTest {
}
```

> [!NOTE]
> By default, a MicroProfile Config profile named "test" is defined.
>
> It can be changed via:
>
> - `@AddConfig(key = "mp.config.profile", value = "otherProfile")`
>
> - `@Configuration(profile = "otherProfile")`
>
> - Using `mp.config.profile` property and `@Config(useExisting = true)`

## CDI Container Setup

By default, CDI discovery is enabled:

- CDI beans and extensions in the classpath are added automatically

- If disabled, the CDI beans and extensions must be added manually

> [!NOTE]
> Customization of the CDI container on a test method changes the CDI
> container affinity.
>
> I.e. The test method will use a dedicated CDI container.

> [!NOTE]
> It is not recommended to provide a `beans.xml` along the test classes,
> as it would combine beans from all tests.
>
> Instead, you should use
> [`@AddBean`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddBean.html)
> to specify the beans per test or method.

CDI discovery can be disabled using
[`@DisableDiscovery`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/DisableDiscovery.html).

Disable discovery:
```java
@DisableDiscovery // Disable CDI discovery
@AddBean(MyBean.class) // Add a bean class
@HelidonTest
class MyTest {
}
```

When disabling discovery, it can be difficult to identify the CDI
extensions needed to activate the desired features.

JAX-RS (Jersey) support can be added easily using
[`@AddJaxRs`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddJaxRs.html).

Add JAX-RS (Jersey):
```java
@DisableDiscovery
@AddJaxRs // Add JAX-RS (Jersey) support
@AddBean(MyResource.class) // Add a resource class to the CDI container
@HelidonTest
class MyTest {
}
```

Note the following Helidon CDI extensions:

| Extension                                                                                                                                        | Note                                                                                                                                              |
|--------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|
| [`ConfigCdiExtension`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.config/io/helidon/microprofile/config/ConfigCdiExtension.html) | Add MicroProfile Config injection support                                                                                                         |
| [`ServerCdiExtension`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.server/io/helidon/microprofile/server/ServerCdiExtension.html) | Optional if using [`@AddJaxRs`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddJaxRs.html) |
| [`JaxRsCdiExtension`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.server/io/helidon/microprofile/server/JaxRsCdiExtension.html)   | Optional if using [`@AddJaxRs`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddJaxRs.html) |

## CDI Container Affinity

By default, one CDI container is created per test class and is shared by
all test methods.

However, test methods can also require a dedicated CDI container:

- By forcing a reset of the CDI container between methods
- By customizing the CDI container per test method

Reset the CDI container between methods:
```java
@HelidonTest(resetPerTest = true)
class MyTest {

    @Test
    void testOne() {
        // executes in a dedicated CDI container
    }

    @Test
    void testTwo() {
        // also executes in a dedicated CDI container
    }
}
```

Customize the CDI container per method:
```java
@HelidonTest
class MyTest {

    @Test
    void testOne() {
        // executes in the shared CDI container
    }

    @Test
    @DisableDiscovery
    @AddBean(MyBean.class)
    void testTwo() {
        // executes in a dedicated CDI container
    }
}
```

## Configuration

The test configuration can be set up in two exclusive ways:

- Using the "synthetic" configuration expressed with annotations
  (default)

- Using the "existing" configuration of the current environment

Use
[`@Configuration`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/Configuration.html)
to switch to the "existing" configuration.

Switch to the existing configuration:
```java
@Configuration(useExisting = true)
@HelidonTest
class MyTest {
}
```

> [!NOTE]
> Customization of the test configuration on a test method changes the
> CDI container affinity.
>
> I.e. The test method will use a dedicated CDI container.

### Synthetic Configuration

The "synthetic" configuration can be expressed using the following
annotations:

| Type                                                                                                                                          | Usage                      |
|-----------------------------------------------------------------------------------------------------------------------------------------------|----------------------------|
| [`@AddConfig`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfig.html)             | Key value pair             |
| [`@AddConfigBlock`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfigBlock.html)   | Formatted text block       |
| [`@AddConfigSource`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfigSource.html) | Programmatic config source |
| [`@Configuration`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/Configuration.html)     | Classpath resources using  |

Add a key value pair:
```java
@AddConfig(key = "foo", value = "bar")
@HelidonTest
class MyTest {
}
```

Add a properties text block:
```java
@AddConfigBlock("""
        foo=bar
        bob=alice
        """)
@HelidonTest
class MyTest {
}
```

Add a YAML text block:
```java
@AddConfigBlock(type = "yaml", value = """
        my-test:
          foo: bar
          bob: alice
        """)
@HelidonTest
class MyTest {
}
```

Add config programmatically:
```java
@HelidonTest
class MyTest {

    @AddConfigSource
    static ConfigSource config() {
        return MpConfigSources.create(Map.of(
                "foo", "bar",
                "bob", "alice"));
    }
}
```

Add classpath resources:
```java
@Configuration(configSources = {
        "my-test1.yaml",
        "my-test2.yaml"
})
@HelidonTest
class MyTest {
}
```

### Configuration Ordering

The ordering of the test configuration can be controlled using the
mechanism defined by the [MicroProfile Config specification](https://download.eclipse.org/microprofile/microprofile-config-3.1/microprofile-config-spec-3.1.html#_configsource_ordering).

Add a properties text block with ordinal:
```java
@AddConfigBlock(value = """
        config_ordinal=120
        foo=bar
        """)
@HelidonTest
class MyTest {
}
```

The default ordering is the following:

| Annotation                                                                                                                                    | Ordinal |
|-----------------------------------------------------------------------------------------------------------------------------------------------|---------|
| [`@AddConfig`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfig.html)             | 1000    |
| [`@AddConfigBlock`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfigBlock.html)   | 900     |
| [`@AddConfigSource`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfigSource.html) | 800     |
| [`@Configuration`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/Configuration.html)     | 700     |

## Injectable Types

Helidon provides injection support for types that reflect the current
server. E.g. JAX-RS client.

Here are all the built-in types that can be injected:

| Type                                                                                                                         | Usage                                              |
|------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------|
| [`WebTarget`](https://jakarta.ee/specifications/restful-ws/3.1/apidocs/jakarta/ws/rs/client/WebTarget.html)                  | A JAX-RS client configured for the current server. |
| `URI`                                                                                                                        | A URI representing the current server              |
| `String`                                                                                                                     | A raw URI representing the current server          |
| [`SeContainer`](https://jakarta.ee/specifications/cdi/4.0/apidocs/jakarta.cdi/jakarta/enterprise/inject/se/SeContainer.html) | The current CDI container instance                 |

> [!NOTE]
> Types that reflect the current server require
> [`ServerCdiExtension`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.server/io/helidon/microprofile/server/ServerCdiExtension.html)

Inject a JAX-RS client for the default socket:
```java
@HelidonTest
class MyTest {

    @Inject
    WebTarget target;
}
```

Use
[`@Socket`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/Socket.html)
to specify the socket for the clients and URIs.

Inject a JAX-RS client for the admin socket:
```java
@HelidonTest
class MyTest {

    @Inject
    @Socket("admin")
    WebTarget target;
}
```

> [!NOTE]
> All the injectable types are also available as method parameters.

Using a method parameter:
```java
@HelidonTest
class MyTest {

    @Test
    void testOne(WebTarget target) {
    }
}
```

## Test Instance Lifecycle

The CDI scope used by the test instance follows the lifecycle defined by
JUnit5. The default is `PER_CLASS` and is enforced by
[`@HelidonTest`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing.junit5/io/helidon/microprofile/testing/junit5/HelidonTest.html).

I.e. By default, the test instance is re-used between test methods.

> [!NOTE]
> The test instance is not re-used between CDI container, using a
> dedicated CDI container implies a new test instance

Using per method lifecycle:

```java
@TestInstance(TestInstance.Lifecycle.PER_METHOD)
@HelidonTest
class MyTest {
}
```

## Using meta-annotations

Meta-annotations are supported on both test classes and test methods and
can be used as a composition mechanism.

Class-level meta-annotation example:
```java
@HelidonTest
@AddBean(FirstBean.class)
@AddBean(SecondBean.class)
@DisableDiscovery
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface CustomMetaAnnotation {
}

@CustomMetaAnnotation
class AnnotationOnClass {
}
```

Method-level meta-annotation example:
```java
@Test
@AddBean(FirstBean.class)
@AddBean(SecondBean.class)
@DisableDiscovery
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface MyTestMethod {
}

@HelidonTest
class AnnotationOnMethod {

    @MyTestMethod
    void testOne() {
    }

    @MyTestMethod
    void testTwo() {
    }
}
```

# API

Here is a brief overview of the MicroProfile testing annotations:

| Annotation                                                                                                                                      | Usage                                                                                                |
|-------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------|
| [`@AddBean`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddBean.html)                   | Add a CDI bean class to the CDI container                                                            |
| [`@AddExtension`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddExtension.html)         | Add a CDI extension to the CDI container                                                             |
| [`@DisableDiscovery`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/DisableDiscovery.html) | Disable automated discovery of beans and extensions                                                  |
| [`@AddJaxRs`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddJaxRs.html)                 | Shorthand to add JAX-RS (Jersey) support                                                             |
| [`@AddConfig`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfig.html)               | Define a key value pair in the "synthetic" configuration                                             |
| [`@AddConfigBlock`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfigBlock.html)     | Define a formatted text block in the "synthetic" configuration                                       |
| [`@AddConfigSource`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AddConfigSource.html)   | Add a programmatic config source to the "synthetic" configuration                                    |
| [`@Configuration`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/Configuration.html)       | Switch between "synthetic" and "existing" ; Add classpath resources to the "synthetic" configuration |
| [`@Socket`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/Socket.html)                     | CDI qualifier to inject a JAX-RS client or URI for a named socket                                    |
| [`@AfterStop`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing/io/helidon/microprofile/testing/AfterStop.html)               | Mark a static method to be executed after the container is stopped                                   |

# Examples

## Config Injection Example

The following example demonstrates how to enable the use of
[`@ConfigProperty`](https://download.eclipse.org/microprofile/microprofile-config-3.1/apidocs/org/eclipse/microprofile/config/inject/ConfigProperty.html)
without CDI discovery.

Config Injection Example:
```java
@HelidonTest
@DisableDiscovery // CDI discovery is disabled
@AddBean(MyBean.class) // Add MyBean to the CDI container
@AddExtension(ConfigCdiExtension.class) // Add ConfigCdiExtension to the CDI container
@AddConfig(key = "app.greeting", value = "TestHello") // Define test configuration
class MyTest {
    @Inject
    MyBean myBean;

    @Test
    void testGreeting() {
        assertThat(myBean, notNullValue());
        assertThat(myBean.greeting(), is("TestHello"));
    }
}

@ApplicationScoped
class MyBean {

    // Inject the configuration
    @ConfigProperty(name = "app.greeting")
    String greeting;

    String greeting() {
        return greeting;
    }
}
```

## Request Scope Example

The following example demonstrates how to use
[`@RequestScoped`](https://jakarta.ee/specifications/cdi/4.0/apidocs/jakarta.cdi/jakarta/enterprise/context/RequestScoped.html)
with JAX-RS without CDI discovery.

Request Scope Example:
```java
@HelidonTest
@DisableDiscovery //  CDI discovery is disabled
@AddJaxRs // Add JAX-RS (Jersey) support
@AddBean(MyResource.class) // Add MyResource to the CDI container
class MyTest {

    @Inject
    WebTarget target;

    @Test
    void testGet() {
        String greeting = target.path("/greeting")
                .request().get(String.class);
        assertThat(greeting, is("Hallo!"));
    }
}

@Path("/greeting")
@RequestScoped
class MyResource {
    @GET
    Response get() {
        return Response.ok("Hallo!").build();
    }
}
```

# Mock Support

Mocking in Helidon MP is all about replacing CDI beans with instrumented
mock classes.

This can be done using CDI alternatives, however Helidon provides an
annotation to make it easy.

## Maven Coordinates

To enable mock support add the following dependency to your project’s
pom.xml.

```xml
<dependency>
    <groupId>io.helidon.microprofile.testing</groupId>
    <artifactId>helidon-microprofile-testing-mocking</artifactId>
    <scope>test</scope>
</dependency>
```

## Usage

Use the
[`@MockBean`](https://helidon.io/docs/v4/apidocs/io.helidon.microprofile.testing.mocking/io/helidon/microprofile/testing/mocking/MockBean.html)
annotation to inject an instrumented CDI bean in your test, and
customize it in the test method.

### Example

Mocking using `@MockBean`:
```java
@HelidonTest
@AddBean(MyResource.class)
@AddBean(MyService.class)
class MyTest {

    // Instrument MyService using Answers.CALLS_REAL_METHODS
    @MockBean(answer = Answers.CALLS_REAL_METHODS)
    MyService myService;

    @Inject
    WebTarget target;

    @Test
    void testService() {
        // Customize the behavior
        Mockito.when(myService.test()).thenReturn("Mocked");

        // Test assertions
        String response = target.path("/test").request().get(String.class);
        assertThat(response, is("Mocked"));
    }
}

@Path("/test")
class MyResource {

    @Inject
    MyService myService;

    @GET
    String test() {
        return myService.test();
    }
}

@ApplicationScoped
class MyService {

    String test() {
        return "Not Mocked";
    }
}
```

## Using CDI Alternative

[`@Alternative`](https://jakarta.ee/specifications/cdi/4.0/apidocs/jakarta.cdi/jakarta/enterprise/inject/Alternative.html)
can be used to replace a CDI bean with an instrumented instance.

Mocking using CDI Alternative:
```java
@HelidonTest
@Priority(1) // Set priority to 1 (required by`@Alternative)
class MyTest {

    @Inject
    WebTarget target;

    MyService myService;

    @BeforeEach
    void initMock() {
        // Create the mock instance in the test class
        myService = Mockito.mock(MyService.class, Answers.CALLS_REAL_METHODS);
    }

    // Create a CDI producer method annotated with @Alternative
    @Produces
    @Alternative
    MyService mockService() {
        return myService;
    }

    @Test
    void testService() {
        // Customize the behavior
        Mockito.when(myService.test()).thenReturn("Mocked");

        // Test assertions
        Response response = target.path("/test").request().get();
        assertThat(response, is("Mocked"));
    }
}

@Path("/test")
class MyResource {

    @Inject
    MyService myService;

    @GET
    String test() {
        return myService.test();
    }
}

@ApplicationScoped
class MyService {

    String test() {
        return "Not Mocked";
    }
}
```

# Virtual Threads

Virtual Threads pinning can be detected during tests.

A virtual thread is "pinning" when it blocks its carrier thread in a way
that prevents the virtual thread scheduler from scheduling other virtual
threads.

This can happen when blocking in native code, or prior to JDK24 when a
blocking IO operation happens in a synchronized block.

Pinning can in some cases negatively affect application performance.

Enable pinning detection:
```java
@HelidonTest(pinningDetection = true)
class MyTest {
}
```

Pinning is considered harmful when it takes longer than 20 milliseconds,
that is also the default when detecting it within tests.

Pinning threshold can be changed with:
```java
// Change pinning threshold from default(20) to 50 milliseconds.
@HelidonTest(pinningDetection = true, pinningThreshold = 50)
class MyTest {
}
```

When pinning is detected, the test fails with a stacktrace pointing at
the culprit.

# Additional Information

- [Official blog article about Helidon and JUnit usage](https://medium.com/helidon/testing-helidon-9df2ea14e22)

# Reference

- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
